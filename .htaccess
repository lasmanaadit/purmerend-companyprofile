
# 1. CONTENT SECURITY POLICY (CSP)
<IfModule mod_headers.c>
    # CSP dengan reporting (jika mau monitor violations)
    Header set Content-Security-Policy "
        default-src 'self';
        script-src 'self' 
                   https://code.jquery.com 
                   https://cdnjs.cloudflare.com 
                   https://cdn.jsdelivr.net
                   'unsafe-inline' 
                   'unsafe-eval';
        style-src 'self' 
                  https://cdnjs.cloudflare.com 
                  https://cdn.jsdelivr.net 
                  'unsafe-inline';
        img-src 'self' data: https:;
        font-src 'self' https://cdnjs.cloudflare.com;
        connect-src 'self';
        frame-src 'none';
        object-src 'none';
        media-src 'self';
        manifest-src 'self';
        worker-src 'self';
        base-uri 'self';
        form-action 'self';
        frame-ancestors 'none';
        block-all-mixed-content;
        upgrade-insecure-requests;
        report-uri /csp-violation-report-endpoint;
    "
    
    # 2. X-FRAME-OPTIONS
    Header always set X-Frame-Options "DENY"
    
    # 3. X-CONTENT-TYPE-OPTIONS
    Header always set X-Content-Type-Options "nosniff"
    
    # 4. REFERRER-POLICY
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    
    # 5. PERMISSIONS-POLICY
    Header always set Permissions-Policy "
        accelerometer=(), 
        ambient-light-sensor=(), 
        autoplay=(), 
        battery=(), 
        camera=(), 
        display-capture=(), 
        document-domain=(), 
        encrypted-media=(), 
        execution-while-not-rendered=(), 
        execution-while-out-of-viewport=(), 
        fullscreen=(self), 
        geolocation=(), 
        gyroscope=(), 
        magnetometer=(), 
        microphone=(), 
        midi=(), 
        navigation-override=(), 
        payment=(), 
        picture-in-picture=(), 
        publickey-credentials-get=(), 
        screen-wake-lock=(), 
        sync-xhr=(), 
        usb=(), 
        web-share=(), 
        xr-spatial-tracking=()
    "
    
    # 6. STRICT TRANSPORT SECURITY (HSTS)
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    
    # 7. FEATURE POLICY (legacy)
    Header always set Feature-Policy "
        accelerometer 'none';
        ambient-light-sensor 'none';
        autoplay 'none';
        battery 'none';
        camera 'none';
        display-capture 'none';
        document-domain 'none';
        encrypted-media 'none';
        execution-while-not-rendered 'none';
        execution-while-out-of-viewport 'none';
        fullscreen 'self';
        geolocation 'none';
        gyroscope 'none';
        magnetometer 'none';
        microphone 'none';
        midi 'none';
        navigation-override 'none';
        payment 'none';
        picture-in-picture 'none';
        publickey-credentials-get 'none';
        screen-wake-lock 'none';
        sync-xhr 'none';
        usb 'none';
        web-share 'none';
        xr-spatial-tracking 'none'
    "
    
    # 8. CROSS-ORIGIN POLICIES
    Header always set Cross-Origin-Embedder-Policy "require-corp"
    Header always set Cross-Origin-Opener-Policy "same-origin"
    Header always set Cross-Origin-Resource-Policy "same-origin"
    
    # 9. EXPECT-CT
    Header always set Expect-CT "max-age=86400, enforce"
    
    # 10. X-PERMITTED-CROSS-DOMAIN-POLICIES
    Header always set X-Permitted-Cross-Domain-Policies "none"
</IfModule>

# ============================================
# BASIC SECURITY RULES
# ============================================

# Block access to sensitive files
<FilesMatch "\.(htaccess|htpasswd|ini|log|sh|sql|bak|backup|zip|tar|env|git)$">
    Order Allow,Deny
    Deny from all
</FilesMatch>

# Disable directory listing
Options -Indexes

# Block access to system folders
RedirectMatch 404 /\.git
RedirectMatch 404 /\.vscode
RedirectMatch 404 /node_modules
RedirectMatch 404 /\.env
RedirectMatch 404 /\.well-known/.*
RedirectMatch 404 /vendor/.*

# Prevent hotlinking
RewriteEngine On
RewriteCond %{HTTP_REFERER} !^$
RewriteCond %{HTTP_REFERER} !^http(s)?://(www\.)?yourdomain.com [NC]
RewriteRule \.(jpg|jpeg|png|gif|css|js)$ - [NC,F,L]

# Force HTTPS (jika sudah ada SSL)
RewriteEngine On
RewriteCond %{HTTPS} off
RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

# ============================================
# PERFORMANCE & CACHE
# ============================================

<IfModule mod_expires.c>
    ExpiresActive On
    ExpiresByType image/jpg "access plus 1 year"
    ExpiresByType image/jpeg "access plus 1 year"
    ExpiresByType image/gif "access plus 1 year"
    ExpiresByType image/png "access plus 1 year"
    ExpiresByType text/css "access plus 1 month"
    ExpiresByType text/javascript "access plus 1 month"
    ExpiresByType application/javascript "access plus 1 month"
    ExpiresByType text/html "access plus 1 hour"
</IfModule>

<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/html text/css text/javascript application/javascript
</IfModule>